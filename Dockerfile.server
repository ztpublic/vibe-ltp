# Dockerfile.server - builds and runs the Express/Socket.IO backend
FROM node:20-alpine AS base

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

WORKDIR /app

# Install with good cache reuse: copy lockfiles + workspace manifests first
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/server/package.json apps/server/package.json
COPY apps/web/package.json apps/web/package.json
COPY packages/config/package.json packages/config/package.json
COPY packages/llm-client/package.json packages/llm-client/package.json
COPY packages/shared/package.json packages/shared/package.json

RUN pnpm install --frozen-lockfile

# Copy full source
COPY . .

# Re-link after full workspace is present (avoids broken pnpm symlinks during build)
RUN pnpm install --frozen-lockfile

# Build workspace deps needed by the server (force rebuild to ensure dist exists)
RUN rm -f packages/shared/tsconfig.tsbuildinfo && pnpm --filter @vibe-ltp/shared exec tsc --build --force
RUN rm -f packages/puzzle-core/tsconfig.tsbuildinfo && pnpm --filter @vibe-ltp/puzzle-core exec tsc --build --force
RUN rm -f packages/llm-client/tsconfig.tsbuildinfo && pnpm --filter @vibe-ltp/llm-client exec tsc --build --force

# Build the server (force fresh TS emit)
RUN rm -f apps/server/tsconfig.tsbuildinfo && pnpm -C apps/server exec tsc --pretty false

# Ensure entrypoint was emitted
RUN test -f apps/server/dist/index.js

# --- RUNTIME IMAGE ---
FROM node:20-alpine AS runner

ARG CORS_ORIGIN=http://localhost:3000

ENV NODE_ENV=production
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV CORS_ORIGIN=${CORS_ORIGIN}
RUN corepack enable

WORKDIR /app

# Copy only what is needed at runtime
COPY --from=base /app/node_modules ./node_modules
COPY --from=base /app/apps/server ./apps/server
COPY --from=base /app/packages ./packages
COPY --from=base /app/package.json ./package.json
COPY --from=base /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=base /app/pnpm-workspace.yaml ./pnpm-workspace.yaml

EXPOSE 4000

CMD ["pnpm", "-C", "apps/server", "start"]
