# Dockerfile.web - builds and runs the Next.js web app
FROM node:20-alpine AS base

ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NEXT_TELEMETRY_DISABLED=1
ARG NEXT_PUBLIC_API_BASE_URL="http://localhost:4000"
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
RUN corepack enable

WORKDIR /app

# Install with maximal cache reuse: copy lockfiles + workspace manifests first
COPY pnpm-lock.yaml pnpm-workspace.yaml package.json ./
COPY apps/web/package.json apps/web/package.json
COPY apps/server/package.json apps/server/package.json
COPY packages/config/package.json packages/config/package.json
COPY packages/llm-client/package.json packages/llm-client/package.json
COPY packages/shared/package.json packages/shared/package.json

RUN pnpm install --frozen-lockfile

# Copy full source for the build
COPY . .

# Re-link after full workspace is present (avoids broken pnpm symlinks during build)
RUN pnpm install --frozen-lockfile

# Build shared workspace needed by the web app (force rebuild to refresh dist)
RUN rm -f packages/shared/tsconfig.tsbuildinfo && pnpm --filter @vibe-ltp/shared exec tsc --build --force

# Build only the web app
RUN pnpm build:web

# --- RUNTIME IMAGE ---
FROM node:20-alpine AS runner

ENV NODE_ENV=production
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
ENV NEXT_TELEMETRY_DISABLED=1
ARG NEXT_PUBLIC_API_BASE_URL="http://localhost:4000"
ENV NEXT_PUBLIC_API_BASE_URL=${NEXT_PUBLIC_API_BASE_URL}
RUN corepack enable

WORKDIR /app

# Only copy what the running app needs
COPY --from=base /app/node_modules ./node_modules
COPY --from=base /app/apps/web ./apps/web
COPY --from=base /app/packages ./packages
COPY --from=base /app/package.json ./package.json
COPY --from=base /app/pnpm-lock.yaml ./pnpm-lock.yaml
COPY --from=base /app/pnpm-workspace.yaml ./pnpm-workspace.yaml

EXPOSE 3000

# Use the app-local start script
CMD ["pnpm", "-C", "apps/web", "start"]
